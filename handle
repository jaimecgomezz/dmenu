#!/usr/bin/env sh

##############################
# @jaimecgomezz
# 
# This script handles all the
# patching related to this
# dmenu distribution
##############################

set -e

handle_std="0"        # Quiet by default
handler="patch -p1"
# handler="git apply" # Can be used as well, but I recommend the default

PATCH_ACTION="patch"
DEPATCH_ACTION="depatch"
TRACK_FILE="applied"
USAGE_FILE="handle-usage"

print_usage() { cat "$USAGE_FILE" ; exit 1 ; }
redirect_output() { eval "$@ > /dev/null 2>&1" ; }
contains() {
  str="$1"; substr="$2"
  if test "${str#*$substr}" != "$str"; then return 0; fi
  return 1
}
report_unapplied() {
  echo "[!] ( $1 ) hasn't been applied yet, add the patch to the file '$TRACK_FILE' if mistaken" ;
  exit 1
}
report_applied() {
  echo "[!] ( $1 ) has already been applied, remove the patch name from the file '$TRACK_FILE' if mistaken" ;
  exit 1
}


# Test args syntax
[ "$#" -lt 2 ] && print_usage
action="$1"; patch="$2"; shift; shift
contains "$@" "-d" && handle_std="1"

case "$action" in
  patch)
  ;;
  depatch)
    options="-R"
  ;;
  *)
    print_usage
  ;;
esac

# Verify patch exists
patches="$( ls patches/*patch | sed -E 's/(^.*\/)(.*)(\..*)/\2/g' )"
if ! echo "$patches" | grep -q "$patch"; then print_usage; fi

# Verify patch status, patched or not
if cat "$TRACK_FILE" | grep -q "$patch"; then
  [ "$action" = "$DEPATCH_ACTION" ] || report_applied "$patch"
else
  [ "$action" = "$PATCH_ACTION" ] || report_unapplied "$patch"
fi

# Patch handlers definition
apply_patch="$handler $options < patches/${patch}.patch"
build_dmenu="sudo make install clean"

# Patch and build quietly by default, unless -d used
[ "$handle_std" = "0" ] && redirect_output "$apply_patch" || eval "$apply_patch"
[ "$handle_std" = "0" ] && redirect_output "$build_dmenu" || eval "$build_dmenu"

# Keep track of applied patches
[ "$action" = "$PATCH_ACTION" ] || sed -i "/^${patch}$/d" "$TRACK_FILE" # If depatch, remove it from track file
[ "$action" = "$DEPATCH_ACTION" ] || echo "$patch" >> "$TRACK_FILE"     # If patch, add it to the trask file

